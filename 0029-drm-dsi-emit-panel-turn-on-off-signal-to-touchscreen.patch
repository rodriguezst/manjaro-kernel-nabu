From 7cda9ed3806044c5dfe8ae75b040b78d50e320a8 Mon Sep 17 00:00:00 2001
From: maverick <maverick_jia@sina.com>
Date: Tue, 12 Dec 2023 05:48:55 +0800
Subject: [PATCH 29/44] drm: dsi: emit panel turn on/off signal to touchscreen

---
 drivers/gpu/drm/msm/dsi/dsi_manager.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/gpu/drm/msm/dsi/dsi_manager.c b/drivers/gpu/drm/msm/dsi/dsi_manager.c
index 3a1417397..980fa766e 100644
--- a/drivers/gpu/drm/msm/dsi/dsi_manager.c
+++ b/drivers/gpu/drm/msm/dsi/dsi_manager.c
@@ -7,6 +7,7 @@
 
 #include "msm_kms.h"
 #include "dsi.h"
+#include "drm/drm_notifier.h"
 
 #define DSI_CLOCK_MASTER	DSI_0
 #define DSI_CLOCK_SLAVE		DSI_1
@@ -318,6 +319,7 @@ static void dsi_mgr_bridge_pre_enable(struct drm_bridge *bridge)
 	struct mipi_dsi_host *host = msm_dsi->host;
 	bool is_bonded_dsi = IS_BONDED_DSI();
 	int ret;
+	enum drm_notifier_data notifier_data;
 
 	DBG("id=%d", id);
 	if (!msm_dsi_device_connected(msm_dsi))
@@ -330,6 +332,9 @@ static void dsi_mgr_bridge_pre_enable(struct drm_bridge *bridge)
 	if (!dsi_mgr_power_on_early(bridge))
 		dsi_mgr_bridge_power_on(bridge);
 
+	notifier_data = MI_DRM_BLANK_UNBLANK;
+	mi_drm_notifier_call_chain(MI_DRM_EVENT_BLANK, &notifier_data);
+
 	ret = msm_dsi_host_enable(host);
 	if (ret) {
 		pr_err("%s: enable host %d failed, %d\n", __func__, id, ret);
@@ -374,12 +379,16 @@ static void dsi_mgr_bridge_post_disable(struct drm_bridge *bridge)
 	struct mipi_dsi_host *host = msm_dsi->host;
 	bool is_bonded_dsi = IS_BONDED_DSI();
 	int ret;
+	enum drm_notifier_data notifier_data;
 
 	DBG("id=%d", id);
 
 	if (!msm_dsi_device_connected(msm_dsi))
 		return;
 
+	notifier_data = MI_DRM_BLANK_POWERDOWN;
+	mi_drm_notifier_call_chain(MI_DRM_EARLY_EVENT_BLANK, &notifier_data);
+
 	/*
 	 * Do nothing with the host if it is slave-DSI in case of bonded DSI.
 	 * It is safe to call dsi_mgr_phy_disable() here because a single PHY
-- 
2.47.0

