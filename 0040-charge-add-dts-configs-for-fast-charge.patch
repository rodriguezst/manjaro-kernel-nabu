From 2afef60a58ddd1b7c5cd264172e3609ccf5ea4b9 Mon Sep 17 00:00:00 2001
From: maverick <maverick_jia@sina.com>
Date: Tue, 30 Jan 2024 14:55:17 +0800
Subject: [PATCH 40/43] charge: add dts configs for fast charge

---
 .../dts/qcom/sm8150-xiaomi-nabu-maverick.dts  | 71 +++++++++++++++++++
 1 file changed, 71 insertions(+)

diff --git a/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu-maverick.dts b/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu-maverick.dts
index db8cb554e..b7c26cd75 100644
--- a/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu-maverick.dts
+++ b/arch/arm64/boot/dts/qcom/sm8150-xiaomi-nabu-maverick.dts
@@ -577,6 +577,50 @@ backlight: backlight@11 {
 	};
 };
 
+&i2c4 {
+	status = "okay";
+
+	ln8000_charger@51 {
+		compatible = "lionsemi,ln8000";
+		reg = <0x51>;
+
+		interrupt-parent = <&tlmm>;
+		interrupts = <36 0x2002>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&ln8000_int_default>;
+
+		ln8000_charger,irq_index = <296>;
+
+		/* device configuration */
+		ln8000_charger,bat-ovp-threshold = <4560>;
+		ln8000_charger,bat-ovp-alarm-threshold = <4525>;
+		ln8000_charger,bus-ovp-threshold = <13000>;
+		ln8000_charger,bus-ovp-alarm-threshold = <11000>;
+		ln8000_charger,bus-ocp-threshold = <3750>;
+		ln8000_charger,bus-ocp-alarm-threshold = <3500>;
+		ln8000_charger,ntc-alarm-cfg  = <226>;
+
+		/* protection enable/disable flags
+		 *   vbat-ovp-disable
+		 *   vbat-reg-disable
+		 *   iin-ocp-disable
+		 *   iin-reg-disable
+		 *   tbus-mon-disable
+		 *   tbat-mon-disable
+		 *   tdie-prot-disable
+		 *   tdie-reg-disable
+		 *   revcurr-prot-disable
+		 */
+		ln8000_charger,tdie-prot-disable;
+		ln8000_charger,tbus-mon-disable;
+		ln8000_charger,tbat-mon-disable;
+		ln8000_charger,iin-ocp-disable;
+		ln8000_charger,iin-reg-disable;
+		ln8000_charger,tdie-reg-disable;
+		ln8000_charger,vbat-reg-disable;
+	};
+};
+
 &i2c7 {
 	status = "okay";
 	clock-frequency = <1000000>;
@@ -759,6 +803,24 @@ config {
 			};
 		};
 	};
+
+	ln8000 {
+		ln8000_int_default: ln8000_int_default {
+			/* active state */
+			mux {
+				/* GPIO 36 is used for ln8000 interrupt usage */
+				pins = "gpio36";
+				function = "gpio";
+			};
+
+			config {
+				pins = "gpio36";
+				drive-strength = <2>; /* 2 MA */
+				bias-pull-up;
+				input-enable;
+			};
+		};
+	};
 };
 
 &uart2 {
@@ -994,6 +1056,15 @@ xiaomi_keyboard {
 		status = "ok";
 	};
 
+	usbpd_pm {
+		compatible = "xiaomi,usbpd-pm";
+		mi,pd-bat-volt-max = <4500>;
+		mi,pd-ffc-bat-volt-max = <4480>;
+		mi,pd-bat-curr-max = <5900>;
+
+		status = "ok";
+	};
+
 	nabu_batterydata: qcom,battery-data {
 		qcom,batt-id-range-pct = <15>;
 		#include "fg-gen4-batterydata-nabu-sunwoda-8720mah.dtsi"
-- 
2.46.0

